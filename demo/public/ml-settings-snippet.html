<!-- ML Settings Button and Modal Snippet -->
<!-- Add this CSS to your <style> section -->
<style>
/* ML Settings Styles */
.ml-settings-btn {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.ml-settings-btn:hover {
    background: #e5e7eb;
    border-color: #9ca3af;
}

.ml-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    animation: fadeIn 0.3s ease-out;
}

.ml-modal-overlay.active {
    display: flex;
    justify-content: center;
    align-items: center;
}

.ml-modal-content {
    background: white;
    border-radius: 12px;
    padding: 24px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    animation: slideUp 0.3s ease-out;
}

.ml-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.ml-modal-title {
    font-size: 20px;
    font-weight: 600;
}

.ml-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #6b7280;
}

.ml-model-selection {
    margin: 20px 0;
}

.ml-model-option {
    display: flex;
    align-items: center;
    padding: 12px;
    margin: 12px 0;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.ml-model-option:hover {
    background: #f9fafb;
    border-color: #3b82f6;
}

.ml-model-option.selected {
    background: #eff6ff;
    border-color: #3b82f6;
}

.ml-model-option input[type="radio"] {
    margin-right: 12px;
}

.ml-model-info {
    flex: 1;
}

.ml-model-name {
    font-weight: 600;
    margin-bottom: 4px;
}

.ml-model-description {
    font-size: 13px;
    color: #6b7280;
}

.ml-performance-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
}

.ml-performance-table th,
.ml-performance-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
}

.ml-performance-table th {
    font-weight: 600;
    background: #f9fafb;
}

.ml-modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 20px;
}

.ml-modal-btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
}

.ml-modal-btn-primary {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.ml-modal-btn-primary:hover {
    background: #2563eb;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}
</style>

<!-- Add this button to your header/navigation -->
<button class="ml-settings-btn" onclick="openMLSettings()" title="ML Model Settings">
    ⚙️ ML Settings
</button>

<!-- Add this modal HTML before closing </body> -->
<div id="mlSettingsModal" class="ml-modal-overlay">
    <div class="ml-modal-content">
        <div class="ml-modal-header">
            <h2 class="ml-modal-title">ML Model Settings</h2>
            <button class="ml-modal-close" onclick="closeMLSettings()">✕</button>
        </div>

        <div class="ml-model-selection">
            <label class="ml-model-option" id="classic-option">
                <input type="radio" name="mlmodel" value="classic" checked>
                <div class="ml-model-info">
                    <div class="ml-model-name">Classic ML Model</div>
                    <div class="ml-model-description">Faster response time, proven in production</div>
                </div>
            </label>

            <label class="ml-model-option" id="ensemble-option">
                <input type="radio" name="mlmodel" value="ensemble">
                <div class="ml-model-info">
                    <div class="ml-model-name">Ensemble ML Model</div>
                    <div class="ml-model-description">Higher accuracy with 7-model voting system</div>
                </div>
            </label>
        </div>

        <h3 style="margin-top: 24px; margin-bottom: 12px;">Performance Comparison</h3>
        <table class="ml-performance-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Classic ML</th>
                    <th>Ensemble ML</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Accuracy</td>
                    <td id="ml-classic-accuracy">92%</td>
                    <td id="ml-ensemble-accuracy">98%</td>
                </tr>
                <tr>
                    <td>F1 Score</td>
                    <td id="ml-classic-f1">0.91</td>
                    <td id="ml-ensemble-f1">0.97</td>
                </tr>
                <tr>
                    <td>Response Time</td>
                    <td id="ml-classic-speed">45ms</td>
                    <td id="ml-ensemble-speed">125ms</td>
                </tr>
                <tr>
                    <td>Total Predictions</td>
                    <td id="ml-classic-usage">15K</td>
                    <td id="ml-ensemble-usage">3K</td>
                </tr>
            </tbody>
        </table>

        <div id="ml-status" style="margin-top: 16px; padding: 12px; background: #f0f9ff; border-radius: 4px; display: none;">
            <span id="ml-status-message"></span>
        </div>

        <div class="ml-modal-actions">
            <button class="ml-modal-btn" onclick="closeMLSettings()">Cancel</button>
            <button class="ml-modal-btn ml-modal-btn-primary" onclick="applyMLSettings()">Apply Changes</button>
        </div>
    </div>
</div>

<!-- Add this JavaScript before closing </body> -->
<script>
// ML Settings Functions
let currentMLModel = localStorage.getItem('ml_model') || 'classic';

function openMLSettings() {
    const modal = document.getElementById('mlSettingsModal');
    modal.classList.add('active');

    // Set current selection
    document.querySelector(`input[name="mlmodel"][value="${currentMLModel}"]`).checked = true;
    updateMLSelectedOption();

    // Load performance metrics
    loadMLPerformanceMetrics();
}

function closeMLSettings() {
    const modal = document.getElementById('mlSettingsModal');
    modal.classList.remove('active');
}

async function applyMLSettings() {
    const selected = document.querySelector('input[name="mlmodel"]:checked').value;

    if (selected === currentMLModel) {
        closeMLSettings();
        return;
    }

    // Show loading status
    const statusDiv = document.getElementById('ml-status');
    const statusMsg = document.getElementById('ml-status-message');
    statusDiv.style.display = 'block';
    statusMsg.textContent = 'Switching models...';

    try {
        const response = await fetch('/api/v1/models/select', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model_type: selected })
        });

        if (response.ok) {
            const data = await response.json();
            currentMLModel = selected;
            localStorage.setItem('ml_model', selected);

            statusMsg.textContent = `✅ Successfully switched to ${selected === 'ensemble' ? 'Ensemble' : 'Classic'} ML model`;
            statusDiv.style.background = '#d4edda';

            setTimeout(() => {
                closeMLSettings();
            }, 2000);
        } else {
            statusMsg.textContent = '❌ Failed to switch model. Please try again.';
            statusDiv.style.background = '#f8d7da';
        }
    } catch (error) {
        console.error('Error switching model:', error);
        statusMsg.textContent = '❌ Network error. Please check your connection.';
        statusDiv.style.background = '#f8d7da';
    }
}

function updateMLSelectedOption() {
    document.querySelectorAll('.ml-model-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    const selected = document.querySelector('input[name="mlmodel"]:checked').value;
    document.getElementById(`${selected}-option`).classList.add('selected');
}

async function loadMLPerformanceMetrics() {
    try {
        const response = await fetch('/api/v1/models/comparison');
        if (response.ok) {
            const data = await response.json();

            // Update classic metrics
            if (data.classic) {
                document.getElementById('ml-classic-accuracy').textContent = `${Math.round(data.classic.accuracy * 100)}%`;
                document.getElementById('ml-classic-f1').textContent = data.classic.f1_score.toFixed(2);
                document.getElementById('ml-classic-speed').textContent = `${data.classic.avg_response_ms || 45}ms`;
                document.getElementById('ml-classic-usage').textContent = `${Math.round(data.classic.total_predictions / 1000)}K`;
            }

            // Update ensemble metrics
            if (data.ensemble) {
                document.getElementById('ml-ensemble-accuracy').textContent = `${Math.round(data.ensemble.accuracy * 100)}%`;
                document.getElementById('ml-ensemble-f1').textContent = data.ensemble.f1_score.toFixed(2);
                document.getElementById('ml-ensemble-speed').textContent = `${data.ensemble.avg_response_ms || 125}ms`;
                document.getElementById('ml-ensemble-usage').textContent = `${Math.round(data.ensemble.total_predictions / 1000)}K`;
            }
        }
    } catch (error) {
        console.error('Error loading performance metrics:', error);
    }
}

// Add event listeners
document.querySelectorAll('input[name="mlmodel"]').forEach(radio => {
    radio.addEventListener('change', updateMLSelectedOption);
});

// Close modal on outside click
document.getElementById('mlSettingsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeMLSettings();
    }
});
</script>